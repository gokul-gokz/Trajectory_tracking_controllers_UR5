%% Control
% initial conditions
x0 = [0.5 0.5 0.5 0.1 0.1 0.1];
t_final = 1000;
% solving ODE
options = odeset('RelTol',1e-4,'AbsTol',[1e-4, 1e-4, 1e-4, 1e-4, 1e-4, 1e-4]);
[T,X] = ode15s(@(t,x) odeur5posTaskSpace(t,x),[0 t_final],x0, options);
% populating the workspace with the thetas
theta1 = X(:,1); theta2 = X(:,2); theta3 = X(:,3);

% doing the FK and finding x, y and z coordinates
Xfull = []; Yfull = []; Zfull = [];
for i=1:length(X(:,1))
    T1 = fk_ur5(theta1(i),theta2(i),theta3(i));
    x = T1(1,4); y = T1(2,4); z = T1(3,4);
    Xfull = [Xfull x]; Yfull = [Yfull y]; Zfull = [Zfull z];
end
% plotting the results
figure(1)
hold on
title('Inverse Dynamics Controller with error in Dynamics for Straight Line')
xlabel('X')
ylabel('Y')
plot(Xfull, Yfull, '-b')
plot(-0.6905*(T/1000)-0.6682*(1-T/1000),-0.3348*(T/1000)-0.3952*(1-T/1000),'-r')

% the ODE functions
function[dq] = odeur5posTaskSpace(t,q)
t
Kp = 1000; Kd = 750.0; m = 1; l1 = 1; l2 = 1; l3 = 1; g=9.8;
    t1 = q(1); t2 = q(2); t3 = q(3); t1_d = q(4); t2_d= q(5); t3_d = q(6);
    theta = [t1;t2;t3]; dtheta = [t1_d;t2_d;t3_d];
std =  0.000058/9;

%% Dynamics
Mmat = [ 0.826179504375*cos(2.0*t2 + t3) - 0.0565404972*sin(2.0*t2 + t3) + 1.20557253125*cos(2.0*t2) + 0.0000000000000000019573801614355403439437524183897*cos(t2 + t3) + 0.000000000000000014511003174485468031141763691783*sin(t2 + t3) + 0.826179504375*cos(t3) + 0.000000000000000015722565581023132984666028219267*sin(t2) - 0.0565404972*sin(t3) + 0.374967577853955*cos(2.0*t2 + 2.0*t3) - 0.052183553004*sin(2.0*t2 + 2.0*t3) + 1.6498961438878783371962262793672,                                                    0.015983221960800000770298430129775*cos(t2 + t3) + 0.11849133304875000319532105772424*sin(t2 + t3) + 0.00000000000000010117780855539904452958870603611*cos(t3) + 0.12838449087500000346210694590899*sin(t2) - 0.0000000000000000069242138918179886397619225021053*sin(t3) + 0.00000000000000019510093541407624091515398576369,                           0.015983221960800000770298430129775*cos(t2 + t3) + 0.11849133304875000319532105772424*sin(t2 + t3) + 0.000000000000000050588904277699522264794353018057*cos(t3) - 0.0000000000000000034621069459089943198809612510527*sin(t3) + 0.000000000000000047460881260547746144125949805253;...
                                                                                                                                  0.015983221960800000770298430129775*cos(t2 + t3) + 0.11849133304875000319532105772424*sin(t2 + t3) + 0.00000000000000010117780855539904452958870603611*cos(t3) + 0.12838449087500000346210694590899*sin(t2) - 0.0000000000000000069242138918179886397619225021053*sin(t3) + 0.00000000000000019510093541407624091515398576369, 3.0976769848028282159067604929052e-33*cos(2.0*t2 + t3) - 2.1199290948066343006048283768305e-34*sin(2.0*t2 + t3) + 4.5201729936265140290864586741331e-33*cos(2.0*t2) + 1.65235900875*cos(t3) - 0.1130809944*sin(t3) + 1.4059032326687268632269500543656e-33*cos(2.0*t2 + 2.0*t3) - 1.9565698527950642456758680724983e-34*sin(2.0*t2 + 2.0*t3) + 4.0105217519862564934991990776325, 1.5488384924014141079533802464526e-33*cos(2.0*t2 + t3) - 1.0599645474033171503024141884152e-34*sin(2.0*t2 + t3) + 0.826179504375*cos(t3) - 0.0565404972*sin(t3) + 1.4059032326687268632269500543656e-33*cos(2.0*t2 + 2.0*t3) - 1.9565698527950642456758680724983e-34*sin(2.0*t2 + 2.0*t3) + 0.77509501177959;...
                                                                                                                                                                             0.015983221960800000770298430129775*cos(t2 + t3) + 0.11849133304875000319532105772424*sin(t2 + t3) + 0.000000000000000050588904277699522264794353018057*cos(t3) - 0.0000000000000000034621069459089943198809612510527*sin(t3) + 0.000000000000000047460881260547746144125949805253,                                                                     1.5488384924014141079533802464526e-33*cos(2.0*t2 + t3) - 1.0599645474033171503024141884152e-34*sin(2.0*t2 + t3) + 0.826179504375*cos(t3) - 0.0565404972*sin(t3) + 1.4059032326687268632269500543656e-33*cos(2.0*t2 + 2.0*t3) - 1.9565698527950642456758680724983e-34*sin(2.0*t2 + 2.0*t3) + 0.77509501177959,                                                                                                                                                 1.4059032326687268632269500543656e-33*cos(2.0*t2 + 2.0*t3) - 1.9565698527950642456758680724983e-34*sin(2.0*t2 + 2.0*t3) + 0.96104026567958999598344970763719];
 
Cmat =[- 0.5*t2_d*(0.1130809944*cos(2.0*t2 + t3)+1.65235900875*sin(2.0*t2 + t3) + 2.4111450625*sin(2.0*t2) - 0.000000000000000014511003174485468031141763691783*cos(t2 + t3) + 0.0000000000000000019573801614355403439437524183897*sin(t2 + t3) - 0.000000000000000015722565581023132984666028219267*cos(t2) + 0.104367106008*cos(2.0*t2 + 2.0*t3) + 0.74993515570791*sin(2.0*t2 + 2.0*t3)) - 0.5*t3_d*(0.0565404972*cos(2.0*t2 + t3) + 0.826179504375*sin(2.0*t2 + t3) - 0.000000000000000014511003174485468031141763691783*cos(t2 + t3) + 0.0000000000000000019573801614355403439437524183897*sin(t2 + t3) + 0.0565404972*cos(t3) + 0.826179504375*sin(t3) + 0.104367106008*cos(2.0*t2 + 2.0*t3) + 0.74993515570791*sin(2.0*t2 + 2.0*t3)),                                                                                                                                          0.0000000000000000072555015872427340155708818458913*cos(t2 + t3) - 0.826179504375*sin(2.0*t2 + t3) - 1.20557253125*sin(2.0*t2) - 0.0565404972*cos(2.0*t2 + t3) - 0.00000000000000000097869008071777017197187620919485*sin(t2 + t3) + 0.0000000000000000078612827905115664923330141096337*cos(t2) - 0.052183553004*cos(2.0*t2 + 2.0*t3) - 0.374967577853955*sin(2.0*t2 + 2.0*t3) - 0.5*t3_d*(0.031966443921600001540596860259551*sin(t2 + t3) - 0.23698266609750000639064211544848*cos(t2 + t3) + 0.0000000000000000069242138918179886397619225021053*cos(t3) + 0.00000000000000010117780855539904452958870603611*sin(t3)) + 0.5*t2_d*(0.23698266609750000639064211544848*cos(t2 + t3) - 0.031966443921600001540596860259551*sin(t2 + t3) + 0.25676898175000000692421389181799*cos(t2)),                                                                                                                                 0.0000000000000000072555015872427340155708818458913*cos(t2 + t3) - 0.4130897521875*sin(2.0*t2 + t3) - 0.0282702486*cos(2.0*t2 + t3) - 0.00000000000000000097869008071777017197187620919485*sin(t2 + t3) - 0.0282702486*cos(t3) - 0.4130897521875*sin(t3) - 0.052183553004*cos(2.0*t2 + 2.0*t3) - 0.374967577853955*sin(2.0*t2 + 2.0*t3) - 0.5*t2_d*(0.031966443921600001540596860259551*sin(t2 + t3) - 0.23698266609750000639064211544848*cos(t2 + t3) + 0.0000000000000000069242138918179886397619225021053*cos(t3) + 0.00000000000000010117780855539904452958870603611*sin(t3)) - 0.5*t3_d*(0.031966443921600001540596860259551*sin(t2 + t3) - 0.23698266609750000639064211544848*cos(t2 + t3) + 0.0000000000000000069242138918179886397619225021053*cos(t3) + 0.00000000000000010117780855539904452958870603611*sin(t3));...
                                                                                                                                                                                                              0.5*t1_d*(0.1130809944*cos(2.0*t2 + t3) + 1.65235900875*sin(2.0*t2 + t3) + 2.4111450625*sin(2.0*t2) - 0.000000000000000014511003174485468031141763691783*cos(t2 + t3) + 0.0000000000000000019573801614355403439437524183897*sin(t2 + t3) - 0.000000000000000015722565581023132984666028219267*cos(t2) + 0.104367106008*cos(2.0*t2 + 2.0*t3) + 0.74993515570791*sin(2.0*t2 + 2.0*t3)) - 0.5*t3_d*(0.0000000000000000069242138918179886397619225021053*cos(t3) + 0.00000000000000010117780855539904452958870603611*sin(t3)), 0.059245666524375001597660528862121*cos(t2 + t3) - 0.0079916109804000003851492150648877*sin(t2 + t3) + 0.064192245437500001731053472954497*cos(t2) - 0.5*t1_d*(0.11849133304875000319532105772424*cos(t2 + t3) - 0.015983221960800000770298430129775*sin(t2 + t3) + 0.12838449087500000346210694590899*cos(t2)) - 0.5*t2_d*(4.239858189613268601209656753661e-34*cos(2.0*t2 + t3) + 6.1953539696056564318135209858103e-33*sin(2.0*t2 + t3) + 9.0403459872530280581729173482661e-33*sin(2.0*t2) + 3.9131397055901284913517361449965e-34*cos(2.0*t2 + 2.0*t3) + 2.8118064653374537264539001087311e-33*sin(2.0*t2 + 2.0*t3)) - 0.5*t3_d*(2.1199290948066343006048283768305e-34*cos(2.0*t2 + t3) + 3.0976769848028282159067604929052e-33*sin(2.0*t2 + t3) + 0.1130809944*cos(t3) + 1.65235900875*sin(t3) + 3.9131397055901284913517361449965e-34*cos(2.0*t2 + 2.0*t3) + 2.8118064653374537264539001087311e-33*sin(2.0*t2 + 2.0*t3)), 0.059245666524375001597660528862121*cos(t2 + t3) - 0.0079916109804000003851492150648877*sin(t2 + t3) - 0.0000000000000000034621069459089943198809612510527*cos(t3) - 0.000000000000000050588904277699522264794353018057*sin(t3) - 0.5*t1_d*(0.11849133304875000319532105772424*cos(t2 + t3) - 0.015983221960800000770298430129775*sin(t2 + t3)) - 0.5*t2_d*(2.1199290948066343006048283768305e-34*cos(2.0*t2 + t3) + 3.0976769848028282159067604929052e-33*sin(2.0*t2 + t3) + 0.1130809944*cos(t3) + 1.65235900875*sin(t3) + 3.9131397055901284913517361449965e-34*cos(2.0*t2 + 2.0*t3) + 2.8118064653374537264539001087311e-33*sin(2.0*t2 + 2.0*t3)) - 0.5*t3_d*(2.1199290948066343006048283768305e-34*cos(2.0*t2 + t3) + 3.0976769848028282159067604929052e-33*sin(2.0*t2 + t3) + 0.1130809944*cos(t3) + 1.65235900875*sin(t3) + 3.9131397055901284913517361449965e-34*cos(2.0*t2 + 2.0*t3) + 2.8118064653374537264539001087311e-33*sin(2.0*t2 + 2.0*t3));...
                                                                                                                                                                                                                                                     0.5*t2_d*(0.0000000000000000069242138918179886397619225021053*cos(t3) + 0.00000000000000010117780855539904452958870603611*sin(t3)) + 0.5*t1_d*(0.0565404972*cos(2.0*t2 + t3) + 0.826179504375*sin(2.0*t2 + t3) - 0.000000000000000014511003174485468031141763691783*cos(t2 + t3) + 0.0000000000000000019573801614355403439437524183897*sin(t2 + t3) + 0.0565404972*cos(t3) + 0.826179504375*sin(t3) + 0.104367106008*cos(2.0*t2 + 2.0*t3) + 0.74993515570791*sin(2.0*t2 + 2.0*t3)),                                                                                                                                       0.059245666524375001597660528862121*cos(t2 + t3) - 0.0079916109804000003851492150648877*sin(t2 + t3) + 0.5*t1_d*(0.015983221960800000770298430129775*sin(t2 + t3) - 0.11849133304875000319532105772424*cos(t2 + t3) + 0.0000000000000000069242138918179886397619225021053*cos(t3) + 0.00000000000000010117780855539904452958870603611*sin(t3)) - 0.5*t3_d*(3.9131397055901284913517361449965e-34*cos(2.0*t2 + 2.0*t3) + 2.8118064653374537264539001087311e-33*sin(2.0*t2 + 2.0*t3)) - 0.5*t2_d*(2.1199290948066343006048283768305e-34*cos(2.0*t2 + t3) + 3.0976769848028282159067604929052e-33*sin(2.0*t2 + t3) - 0.1130809944*cos(t3) - 1.65235900875*sin(t3) + 3.9131397055901284913517361449965e-34*cos(2.0*t2 + 2.0*t3) + 2.8118064653374537264539001087311e-33*sin(2.0*t2 + 2.0*t3)),                                                                                                                                                                                                        0.059245666524375001597660528862121*cos(t2 + t3) - 0.0079916109804000003851492150648877*sin(t2 + t3) - 0.0000000000000000017310534729544971599404806255263*cos(t3) - 0.000000000000000025294452138849761132397176509029*sin(t3) + 0.5*t1_d*(0.015983221960800000770298430129775*sin(t2 + t3) - 0.11849133304875000319532105772424*cos(t2 + t3) + 0.0000000000000000034621069459089943198809612510527*cos(t3) + 0.000000000000000050588904277699522264794353018057*sin(t3)) - 0.5*t2_d*(3.9131397055901284913517361449965e-34*cos(2.0*t2 + 2.0*t3) + 2.8118064653374537264539001087311e-33*sin(2.0*t2 + 2.0*t3)) - 0.5*t3_d*(3.9131397055901284913517361449965e-34*cos(2.0*t2 + 2.0*t3) + 2.8118064653374537264539001087311e-33*sin(2.0*t2 + 2.0*t3))];
Gmat = g*[1.5200799240000000184971359776743 - 1.943951775*sin(t2 + t3) - 5.6732825*sin(t2) - 0.133036464*cos(t2 + t3);...
 1.5200799240000000184971359776743 - 1.943951775*sin(t2 + t3) - 5.6732825*sin(t2) - 0.133036464*cos(t2 + t3);...
 1.5200799240000000184971359776743 - 1.943951775*sin(t2 + t3) - 5.6732825*sin(t2) - 0.133036464*cos(t2 + t3)];

invM = inv(Mmat);

%% Jacobian
J = [ 0.19145000000000000579013006636869*cos(t1) + 0.39225*cos(t3)*(0.00000000000000006123233995736766035868820147292*cos(t1)*sin(t2) + cos(t2)*sin(t1)) + 0.000000000000000026023744481881255652442485625991*cos(t1)*sin(t2) + 0.425*cos(t2)*sin(t1) - 0.09456*sin(t3)*(0.00000000000000006123233995736766035868820147292*cos(t1)*sin(t2) + cos(t2)*sin(t1)) + 0.09456*cos(t3)*(0.00000000000000006123233995736766035868820147292*cos(t1)*cos(t2) - 1.0*sin(t1)*sin(t2)) + 0.39225*sin(t3)*(0.00000000000000006123233995736766035868820147292*cos(t1)*cos(t2) - 1.0*sin(t1)*sin(t2)),         0.09456*cos(t3)*(cos(t1)*cos(t2) - 0.00000000000000006123233995736766035868820147292*sin(t1)*sin(t2)) + 0.39225*cos(t3)*(cos(t1)*sin(t2) + 0.00000000000000006123233995736766035868820147292*cos(t2)*sin(t1)) + 0.425*cos(t1)*sin(t2) + 0.000000000000000026023744481881255652442485625991*cos(t2)*sin(t1) + 0.39225*sin(t3)*(cos(t1)*cos(t2) - 0.00000000000000006123233995736766035868820147292*sin(t1)*sin(t2)) - 0.09456*sin(t3)*(cos(t1)*sin(t2) + 0.00000000000000006123233995736766035868820147292*cos(t2)*sin(t1)),         0.09456*cos(t3)*(cos(t1)*cos(t2) - 0.00000000000000006123233995736766035868820147292*sin(t1)*sin(t2)) + 0.39225*cos(t3)*(cos(t1)*sin(t2) + 0.00000000000000006123233995736766035868820147292*cos(t2)*sin(t1)) + 0.39225*sin(t3)*(cos(t1)*cos(t2) - 0.00000000000000006123233995736766035868820147292*sin(t1)*sin(t2)) - 0.09456*sin(t3)*(cos(t1)*sin(t2) + 0.00000000000000006123233995736766035868820147292*cos(t2)*sin(t1));...
         0.19145000000000000579013006636869*sin(t1) - 0.425*cos(t1)*cos(t2) - 0.39225*cos(t3)*(cos(t1)*cos(t2) - 0.00000000000000006123233995736766035868820147292*sin(t1)*sin(t2)) + 0.09456*cos(t3)*(cos(t1)*sin(t2) + 0.00000000000000006123233995736766035868820147292*cos(t2)*sin(t1)) + 0.09456*sin(t3)*(cos(t1)*cos(t2) - 0.00000000000000006123233995736766035868820147292*sin(t1)*sin(t2)) + 0.39225*sin(t3)*(cos(t1)*sin(t2) + 0.00000000000000006123233995736766035868820147292*cos(t2)*sin(t1)) + 0.000000000000000026023744481881255652442485625991*sin(t1)*sin(t2), 0.09456*cos(t3)*(0.00000000000000006123233995736766035868820147292*cos(t1)*sin(t2) + cos(t2)*sin(t1)) - 0.000000000000000026023744481881255652442485625991*cos(t1)*cos(t2) + 0.39225*sin(t3)*(0.00000000000000006123233995736766035868820147292*cos(t1)*sin(t2) + cos(t2)*sin(t1)) + 0.425*sin(t1)*sin(t2) - 0.39225*cos(t3)*(0.00000000000000006123233995736766035868820147292*cos(t1)*cos(t2) - 1.0*sin(t1)*sin(t2)) + 0.09456*sin(t3)*(0.00000000000000006123233995736766035868820147292*cos(t1)*cos(t2) - 1.0*sin(t1)*sin(t2)), 0.09456*cos(t3)*(0.00000000000000006123233995736766035868820147292*cos(t1)*sin(t2) + cos(t2)*sin(t1)) + 0.39225*sin(t3)*(0.00000000000000006123233995736766035868820147292*cos(t1)*sin(t2) + cos(t2)*sin(t1)) - 0.39225*cos(t3)*(0.00000000000000006123233995736766035868820147292*cos(t1)*cos(t2) - 1.0*sin(t1)*sin(t2)) + 0.09456*sin(t3)*(0.00000000000000006123233995736766035868820147292*cos(t1)*cos(t2) - 1.0*sin(t1)*sin(t2));...
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               0,                                                                                                                                                                                                                                                                                                                                                                                                              0.09456*cos(t2)*sin(t3) - 0.39225*cos(t2)*cos(t3) - 0.425*cos(t2) + 0.09456*cos(t3)*sin(t2) + 0.39225*sin(t2)*sin(t3),                                                                                                                                                                                                                                                                                                                                 0.09456*cos(t2)*sin(t3) - 0.39225*cos(t2)*cos(t3) + 0.09456*cos(t3)*sin(t2) + 0.39225*sin(t2)*sin(t3)];
Jdot = [ 0.39225*cos(t3)*(t1_d*cos(t1)*cos(t2) + 0.00000000000000006123233995736766035868820147292*t2_d*cos(t1)*cos(t2) - 0.00000000000000006123233995736766035868820147292*t1_d*sin(t1)*sin(t2) - 1.0*t2_d*sin(t1)*sin(t2)) - 0.19145000000000000579013006636869*t1_d*sin(t1) - 0.09456*sin(t3)*(t1_d*cos(t1)*cos(t2) + 0.00000000000000006123233995736766035868820147292*t2_d*cos(t1)*cos(t2) - 0.00000000000000006123233995736766035868820147292*t1_d*sin(t1)*sin(t2) - 1.0*t2_d*sin(t1)*sin(t2)) - 0.09456*cos(t3)*(1.0*t1_d*cos(t1)*sin(t2) + 0.00000000000000006123233995736766035868820147292*t1_d*cos(t2)*sin(t1) + 0.00000000000000006123233995736766035868820147292*t2_d*cos(t1)*sin(t2) + 1.0*t2_d*cos(t2)*sin(t1)) - 0.39225*sin(t3)*(1.0*t1_d*cos(t1)*sin(t2) + 0.00000000000000006123233995736766035868820147292*t1_d*cos(t2)*sin(t1) + 0.00000000000000006123233995736766035868820147292*t2_d*cos(t1)*sin(t2) + 1.0*t2_d*cos(t2)*sin(t1)) + 0.425*t1_d*cos(t1)*cos(t2) + 0.000000000000000026023744481881255652442485625991*t2_d*cos(t1)*cos(t2) - 0.09456*t3_d*cos(t3)*(0.00000000000000006123233995736766035868820147292*cos(t1)*sin(t2) + cos(t2)*sin(t1)) - 0.39225*t3_d*sin(t3)*(0.00000000000000006123233995736766035868820147292*cos(t1)*sin(t2) + cos(t2)*sin(t1)) - 0.000000000000000026023744481881255652442485625991*t1_d*sin(t1)*sin(t2) - 0.425*t2_d*sin(t1)*sin(t2) + 0.39225*t3_d*cos(t3)*(0.00000000000000006123233995736766035868820147292*cos(t1)*cos(t2) - 1.0*sin(t1)*sin(t2)) - 0.09456*t3_d*sin(t3)*(0.00000000000000006123233995736766035868820147292*cos(t1)*cos(t2) - 1.0*sin(t1)*sin(t2)),                         0.39225*cos(t3)*(0.00000000000000006123233995736766035868820147292*t1_d*cos(t1)*cos(t2) + t2_d*cos(t1)*cos(t2) - 1.0*t1_d*sin(t1)*sin(t2) - 0.00000000000000006123233995736766035868820147292*t2_d*sin(t1)*sin(t2)) - 0.39225*sin(t3)*(0.00000000000000006123233995736766035868820147292*t1_d*cos(t1)*sin(t2) + t1_d*cos(t2)*sin(t1) + t2_d*cos(t1)*sin(t2) + 0.00000000000000006123233995736766035868820147292*t2_d*cos(t2)*sin(t1)) - 0.09456*cos(t3)*(0.00000000000000006123233995736766035868820147292*t1_d*cos(t1)*sin(t2) + t1_d*cos(t2)*sin(t1) + t2_d*cos(t1)*sin(t2) + 0.00000000000000006123233995736766035868820147292*t2_d*cos(t2)*sin(t1)) - 0.09456*sin(t3)*(0.00000000000000006123233995736766035868820147292*t1_d*cos(t1)*cos(t2) + t2_d*cos(t1)*cos(t2) - 1.0*t1_d*sin(t1)*sin(t2) - 0.00000000000000006123233995736766035868820147292*t2_d*sin(t1)*sin(t2)) + 0.000000000000000026023744481881255652442485625991*t1_d*cos(t1)*cos(t2) + 0.425*t2_d*cos(t1)*cos(t2) + 0.39225*t3_d*cos(t3)*(cos(t1)*cos(t2) - 0.00000000000000006123233995736766035868820147292*sin(t1)*sin(t2)) - 0.09456*t3_d*cos(t3)*(cos(t1)*sin(t2) + 0.00000000000000006123233995736766035868820147292*cos(t2)*sin(t1)) - 0.09456*t3_d*sin(t3)*(cos(t1)*cos(t2) - 0.00000000000000006123233995736766035868820147292*sin(t1)*sin(t2)) - 0.39225*t3_d*sin(t3)*(cos(t1)*sin(t2) + 0.00000000000000006123233995736766035868820147292*cos(t2)*sin(t1)) - 0.425*t1_d*sin(t1)*sin(t2) - 0.000000000000000026023744481881255652442485625991*t2_d*sin(t1)*sin(t2),                         0.39225*cos(t3)*(0.00000000000000006123233995736766035868820147292*t1_d*cos(t1)*cos(t2) + t2_d*cos(t1)*cos(t2) - 1.0*t1_d*sin(t1)*sin(t2) - 0.00000000000000006123233995736766035868820147292*t2_d*sin(t1)*sin(t2)) - 0.39225*sin(t3)*(0.00000000000000006123233995736766035868820147292*t1_d*cos(t1)*sin(t2) + t1_d*cos(t2)*sin(t1) + t2_d*cos(t1)*sin(t2) + 0.00000000000000006123233995736766035868820147292*t2_d*cos(t2)*sin(t1)) - 0.09456*cos(t3)*(0.00000000000000006123233995736766035868820147292*t1_d*cos(t1)*sin(t2) + t1_d*cos(t2)*sin(t1) + t2_d*cos(t1)*sin(t2) + 0.00000000000000006123233995736766035868820147292*t2_d*cos(t2)*sin(t1)) - 0.09456*sin(t3)*(0.00000000000000006123233995736766035868820147292*t1_d*cos(t1)*cos(t2) + t2_d*cos(t1)*cos(t2) - 1.0*t1_d*sin(t1)*sin(t2) - 0.00000000000000006123233995736766035868820147292*t2_d*sin(t1)*sin(t2)) + 0.39225*t3_d*cos(t3)*(cos(t1)*cos(t2) - 0.00000000000000006123233995736766035868820147292*sin(t1)*sin(t2)) - 0.09456*t3_d*cos(t3)*(cos(t1)*sin(t2) + 0.00000000000000006123233995736766035868820147292*cos(t2)*sin(t1)) - 0.09456*t3_d*sin(t3)*(cos(t1)*cos(t2) - 0.00000000000000006123233995736766035868820147292*sin(t1)*sin(t2)) - 0.39225*t3_d*sin(t3)*(cos(t1)*sin(t2) + 0.00000000000000006123233995736766035868820147292*cos(t2)*sin(t1));...
                         0.39225*cos(t3)*(0.00000000000000006123233995736766035868820147292*t1_d*cos(t1)*sin(t2) + t1_d*cos(t2)*sin(t1) + t2_d*cos(t1)*sin(t2) + 0.00000000000000006123233995736766035868820147292*t2_d*cos(t2)*sin(t1)) - 0.09456*sin(t3)*(0.00000000000000006123233995736766035868820147292*t1_d*cos(t1)*sin(t2) + t1_d*cos(t2)*sin(t1) + t2_d*cos(t1)*sin(t2) + 0.00000000000000006123233995736766035868820147292*t2_d*cos(t2)*sin(t1)) + 0.19145000000000000579013006636869*t1_d*cos(t1) + 0.09456*cos(t3)*(0.00000000000000006123233995736766035868820147292*t1_d*cos(t1)*cos(t2) + t2_d*cos(t1)*cos(t2) - 1.0*t1_d*sin(t1)*sin(t2) - 0.00000000000000006123233995736766035868820147292*t2_d*sin(t1)*sin(t2)) + 0.39225*sin(t3)*(0.00000000000000006123233995736766035868820147292*t1_d*cos(t1)*cos(t2) + t2_d*cos(t1)*cos(t2) - 1.0*t1_d*sin(t1)*sin(t2) - 0.00000000000000006123233995736766035868820147292*t2_d*sin(t1)*sin(t2)) + 0.09456*t3_d*cos(t3)*(cos(t1)*cos(t2) - 0.00000000000000006123233995736766035868820147292*sin(t1)*sin(t2)) + 0.39225*t3_d*cos(t3)*(cos(t1)*sin(t2) + 0.00000000000000006123233995736766035868820147292*cos(t2)*sin(t1)) + 0.000000000000000026023744481881255652442485625991*t1_d*cos(t1)*sin(t2) + 0.425*t1_d*cos(t2)*sin(t1) + 0.425*t2_d*cos(t1)*sin(t2) + 0.000000000000000026023744481881255652442485625991*t2_d*cos(t2)*sin(t1) + 0.39225*t3_d*sin(t3)*(cos(t1)*cos(t2) - 0.00000000000000006123233995736766035868820147292*sin(t1)*sin(t2)) - 0.09456*t3_d*sin(t3)*(cos(t1)*sin(t2) + 0.00000000000000006123233995736766035868820147292*cos(t2)*sin(t1)), 0.09456*cos(t3)*(t1_d*cos(t1)*cos(t2) + 0.00000000000000006123233995736766035868820147292*t2_d*cos(t1)*cos(t2) - 0.00000000000000006123233995736766035868820147292*t1_d*sin(t1)*sin(t2) - 1.0*t2_d*sin(t1)*sin(t2)) + 0.39225*sin(t3)*(t1_d*cos(t1)*cos(t2) + 0.00000000000000006123233995736766035868820147292*t2_d*cos(t1)*cos(t2) - 0.00000000000000006123233995736766035868820147292*t1_d*sin(t1)*sin(t2) - 1.0*t2_d*sin(t1)*sin(t2)) + 0.39225*cos(t3)*(1.0*t1_d*cos(t1)*sin(t2) + 0.00000000000000006123233995736766035868820147292*t1_d*cos(t2)*sin(t1) + 0.00000000000000006123233995736766035868820147292*t2_d*cos(t1)*sin(t2) + 1.0*t2_d*cos(t2)*sin(t1)) - 0.09456*sin(t3)*(1.0*t1_d*cos(t1)*sin(t2) + 0.00000000000000006123233995736766035868820147292*t1_d*cos(t2)*sin(t1) + 0.00000000000000006123233995736766035868820147292*t2_d*cos(t1)*sin(t2) + 1.0*t2_d*cos(t2)*sin(t1)) + 0.39225*t3_d*cos(t3)*(0.00000000000000006123233995736766035868820147292*cos(t1)*sin(t2) + cos(t2)*sin(t1)) + 0.425*t1_d*cos(t1)*sin(t2) + 0.000000000000000026023744481881255652442485625991*t1_d*cos(t2)*sin(t1) + 0.000000000000000026023744481881255652442485625991*t2_d*cos(t1)*sin(t2) + 0.425*t2_d*cos(t2)*sin(t1) - 0.09456*t3_d*sin(t3)*(0.00000000000000006123233995736766035868820147292*cos(t1)*sin(t2) + cos(t2)*sin(t1)) + 0.09456*t3_d*cos(t3)*(0.00000000000000006123233995736766035868820147292*cos(t1)*cos(t2) - 1.0*sin(t1)*sin(t2)) + 0.39225*t3_d*sin(t3)*(0.00000000000000006123233995736766035868820147292*cos(t1)*cos(t2) - 1.0*sin(t1)*sin(t2)), 0.09456*cos(t3)*(t1_d*cos(t1)*cos(t2) + 0.00000000000000006123233995736766035868820147292*t2_d*cos(t1)*cos(t2) - 0.00000000000000006123233995736766035868820147292*t1_d*sin(t1)*sin(t2) - 1.0*t2_d*sin(t1)*sin(t2)) + 0.39225*sin(t3)*(t1_d*cos(t1)*cos(t2) + 0.00000000000000006123233995736766035868820147292*t2_d*cos(t1)*cos(t2) - 0.00000000000000006123233995736766035868820147292*t1_d*sin(t1)*sin(t2) - 1.0*t2_d*sin(t1)*sin(t2)) + 0.39225*cos(t3)*(1.0*t1_d*cos(t1)*sin(t2) + 0.00000000000000006123233995736766035868820147292*t1_d*cos(t2)*sin(t1) + 0.00000000000000006123233995736766035868820147292*t2_d*cos(t1)*sin(t2) + 1.0*t2_d*cos(t2)*sin(t1)) - 0.09456*sin(t3)*(1.0*t1_d*cos(t1)*sin(t2) + 0.00000000000000006123233995736766035868820147292*t1_d*cos(t2)*sin(t1) + 0.00000000000000006123233995736766035868820147292*t2_d*cos(t1)*sin(t2) + 1.0*t2_d*cos(t2)*sin(t1)) + 0.39225*t3_d*cos(t3)*(0.00000000000000006123233995736766035868820147292*cos(t1)*sin(t2) + cos(t2)*sin(t1)) - 0.09456*t3_d*sin(t3)*(0.00000000000000006123233995736766035868820147292*cos(t1)*sin(t2) + cos(t2)*sin(t1)) + 0.09456*t3_d*cos(t3)*(0.00000000000000006123233995736766035868820147292*cos(t1)*cos(t2) - 1.0*sin(t1)*sin(t2)) + 0.39225*t3_d*sin(t3)*(0.00000000000000006123233995736766035868820147292*cos(t1)*cos(t2) - 1.0*sin(t1)*sin(t2));...
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         0,                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              0.425*t2_d*sin(t2) + 0.09456*t2_d*cos(t2)*cos(t3) + 0.09456*t3_d*cos(t2)*cos(t3) + 0.39225*t2_d*cos(t2)*sin(t3) + 0.39225*t2_d*cos(t3)*sin(t2) + 0.39225*t3_d*cos(t2)*sin(t3) + 0.39225*t3_d*cos(t3)*sin(t2) - 0.09456*t2_d*sin(t2)*sin(t3) - 0.09456*t3_d*sin(t2)*sin(t3),                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     0.09456*t2_d*cos(t2)*cos(t3) + 0.09456*t3_d*cos(t2)*cos(t3) + 0.39225*t2_d*cos(t2)*sin(t3) + 0.39225*t2_d*cos(t3)*sin(t2) + 0.39225*t3_d*cos(t2)*sin(t3) + 0.39225*t3_d*cos(t3)*sin(t2) - 0.09456*t2_d*sin(t2)*sin(t3) - 0.09456*t3_d*sin(t2)*sin(t3)];

T = fk_ur5(t1,t2,t3);
x = [T(1,4);T(2,4);T(3,4)];
xdot = J*dtheta;
x_d = [0.2*sin(0.01*t)-0.4;0.2*cos(0.01*t)-0.4;-0.1];
dx_d = 0.01*[0.2*cos(0.01*t);-0.2*sin(0.01*t);0];
ddx_d = 0.01^2*[-0.2*sin(0.01*t);-0.2*cos(0.01*t);0];
x_d =  [-0.6905*(t/1000)-0.6682*(1-t/1000);-0.3348*(t/1000)-0.3952*(1-t/1000);-0.2351];
dx_d =  1.0e-04 *[-0.2230;0.6040;0];
ddx_d = [0;0;0];

ddx = ddx_d - Kp*(x-x_d)-Kd*(xdot-dx_d);
Torque = invM*(inv(J)*ddx - Jdot*dtheta)+ Cmat*dtheta +Gmat;
dq = [dtheta; invM*(Torque- Gmat)-invM*Cmat*dtheta];
    

end

% The forward kinematics function
function [T] = fk_ur5(q1,q2,q3)
%% Transformation Matrices Using DH Parameters (a, alpha, theta, d)

T10 = DH_matrix(0, pi/2, q1, 0.08916);
T21 = DH_matrix(-0.425, 0, q2, 0);
T32 = DH_matrix(-0.39225, 0, q3, 0);
T43 = DH_matrix(0, pi/2, 0, 0.10915);
T54 = DH_matrix(0, -pi/2, 0, 0.09456);
T65 = DH_matrix(0, 0, 0, 0.0823);

%% Transformation Matrices wrt Base frames
T20 = T10 * T21;
T30 = T20 * T32;
T40 = T30 * T43;
T50 = T40 * T54;
T = T50 * T65;

end
