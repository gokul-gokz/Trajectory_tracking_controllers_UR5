%% Control
% initial conditions
x0 = [0.5 0.5 0.5 0.1 0.1 0.1];
t_final = 1000;
% solving ODE
options = odeset('RelTol',1e-4,'AbsTol',[1e-4, 1e-4, 1e-4, 1e-4, 1e-4, 1e-4]);
[T,X] = ode15s(@(t,x) odeur5posRobust(t,x),[0 t_final],x0, options);
% populating the workspace with the thetas
theta1 = X(:,1); theta2 = X(:,2); theta3 = X(:,3);

% doing the FK and finding x, y and z coordinates
Xfull = []; Yfull = []; Zfull = [];
for i=1:length(X(:,1))
    T1 = fk_ur5(theta1(i),theta2(i),theta3(i));
    x = T1(1,4); y = T1(2,4); z = T1(3,4);
    Xfull = [Xfull x]; Yfull = [Yfull y]; Zfull = [Zfull z];
end
% plotting the results
figure(1)
hold on
title('Robust Feedback Control for Straight Line with error in estimate')
xlabel('X')
ylabel('Y')
plot(Xfull, Yfull, '-b')
plot(-0.6905*(T/1000)-0.6682*(1-T/1000),-0.3348*(T/1000)-0.3952*(1-T/1000),'-r')

% the ODE functions
function[dq] = odeur5posRobust(t,q)
t
Kp = 350; Kd = 220;
Kp = [100 0 0;...
    0       100 0;...
    0       0   100];
Kd = [75   0   0;...
        0   75 0;...
        0   0   75];
m = 1; l1 = 1; l2 = 1; l3 = 1; g=9.8;
    t1 = q(1); t2 = q(2); t3 = q(3); t1_d = q(4); t2_d= q(5); t3_d = q(6);
    theta = [t1;t2;t3]; dtheta = [t1_d;t2_d;t3_d];
m1 = 3; m2 = 4; m3 = 6;
%% Estimated Values
Mest = [ 0.0014083333333333333333333333333333*m1 + 0.0903125*m2 + 0.16724253125*m3 + 0.437753941875*cos(2.0*t2 + t3) - 0.0565404972*sin(2.0*t2 + t3) + 0.23715159375*cos(2.0*t2) + 0.437753941875*cos(t3) - 0.0565404972*sin(t3) + 0.195720605041455*cos(2.0*t2 + 2.0*t3) - 0.052183553004*sin(2.0*t2 + 2.0*t3) + 0.16670625*m3*cos(2.0*t2 + t3) + 0.0903125*m2*cos(2.0*t2) + 0.0903125*m3*cos(2.0*t2) + 0.16670625*m3*cos(t3) + 0.07693003125*m3*cos(2.0*t2 + 2.0*t3) + 0.481384900242045,                                                           0.0159832219608*cos(t2 + t3) + 0.11849133304875*sin(t2 + t3) + 0.128384490875*sin(t2),                                               0.0159832219608*cos(t2 + t3) + 0.11849133304875*sin(t2 + t3);...
    0.0159832219608*cos(t2 + t3) + 0.11849133304875*sin(t2 + t3) + 0.128384490875*sin(t2), 0.2051776533333333268904752344497*m2 + 0.3344850625*m3 + 0.87550788375*cos(t3) - 0.1130809944*sin(t3) + 0.3334125*m3*cos(t3) + 0.89090425365459, 0.1538600625*m3 + 0.437753941875*cos(t3) - 0.0565404972*sin(t3) + 0.16670625*m3*cos(t3) + 0.41660106615459;...
    0.0159832219608*cos(t2 + t3) + 0.11849133304875*sin(t2 + t3),                                      0.1538600625*m3 + 0.437753941875*cos(t3) - 0.0565404972*sin(t3) + 0.16670625*m3*cos(t3) + 0.41660106615459,                                                   0.17381127000000000063121656050195*m3 + 0.41660106615459];
 
Cest = [ - 0.5*t2_d*(0.1130809944*cos(2.0*t2 + t3) + 0.87550788375*sin(2.0*t2 + t3) + 0.4743031875*sin(2.0*t2) + 0.104367106008*cos(2.0*t2 + 2.0*t3) + 0.39144121008291*sin(2.0*t2 + 2.0*t3) + 0.3334125*m3*sin(2.0*t2 + t3) + 0.180625*m2*sin(2.0*t2) + 0.180625*m3*sin(2.0*t2) + 0.1538600625*m3*sin(2.0*t2 + 2.0*t3)) - 0.5*t3_d*(0.0565404972*cos(2.0*t2 + t3) + 0.437753941875*sin(2.0*t2 + t3) + 0.0565404972*cos(t3) + 0.437753941875*sin(t3) + 0.104367106008*cos(2.0*t2 + 2.0*t3) + 0.39144121008291*sin(2.0*t2 + 2.0*t3) + 0.16670625*m3*sin(2.0*t2 + t3) + 0.16670625*m3*sin(t3) + 0.1538600625*m3*sin(2.0*t2 + 2.0*t3)), 0.5*t3_d*(0.2369826660975*cos(t2 + t3) - 0.0319664439216*sin(t2 + t3)) - 0.437753941875*sin(2.0*t2 + t3) - 0.23715159375*sin(2.0*t2) - 0.052183553004*cos(2.0*t2 + 2.0*t3) - 0.195720605041455*sin(2.0*t2 + 2.0*t3) - 0.0565404972*cos(2.0*t2 + t3) - 0.16670625*m3*sin(2.0*t2 + t3) - 0.0903125*m2*sin(2.0*t2) - 0.0903125*m3*sin(2.0*t2) + 0.5*t2_d*(0.2369826660975*cos(t2 + t3) - 0.0319664439216*sin(t2 + t3) + 0.25676898175*cos(t2)) - 0.07693003125*m3*sin(2.0*t2 + 2.0*t3), 0.5*t2_d*(0.2369826660975*cos(t2 + t3) - 0.0319664439216*sin(t2 + t3)) - 0.2188769709375*sin(2.0*t2 + t3) - 0.0282702486*cos(t3) - 0.2188769709375*sin(t3) - 0.052183553004*cos(2.0*t2 + 2.0*t3) - 0.195720605041455*sin(2.0*t2 + 2.0*t3) - 0.0282702486*cos(2.0*t2 + t3) + 0.5*t3_d*(0.2369826660975*cos(t2 + t3) - 0.0319664439216*sin(t2 + t3)) - 0.083353125*m3*sin(2.0*t2 + t3) - 0.083353125*m3*sin(t3) - 0.07693003125*m3*sin(2.0*t2 + 2.0*t3);...
    0.5*t1_d*(0.1130809944*cos(2.0*t2 + t3) + 0.87550788375*sin(2.0*t2 + t3) + 0.4743031875*sin(2.0*t2) + 0.104367106008*cos(2.0*t2 + 2.0*t3) + 0.39144121008291*sin(2.0*t2 + 2.0*t3) + 0.3334125*m3*sin(2.0*t2 + t3) + 0.180625*m2*sin(2.0*t2) + 0.180625*m3*sin(2.0*t2) + 0.1538600625*m3*sin(2.0*t2 + 2.0*t3)),                                                                                                                                                                                                         0.059245666524375*cos(t2 + t3) - 0.0079916109804*sin(t2 + t3) + 0.0641922454375*cos(t2) - 0.5*t1_d*(0.11849133304875*cos(t2 + t3) - 0.0159832219608*sin(t2 + t3) + 0.128384490875*cos(t2)) - 0.5*t3_d*(0.1130809944*cos(t3) + 0.87550788375*sin(t3) + 0.3334125*m3*sin(t3)),                                                                                                                                             0.059245666524375*cos(t2 + t3) - 0.0079916109804*sin(t2 + t3) - 0.5*t1_d*(0.11849133304875*cos(t2 + t3) - 0.0159832219608*sin(t2 + t3)) - 0.5*t2_d*(0.1130809944*cos(t3) + 0.87550788375*sin(t3) + 0.3334125*m3*sin(t3)) - 0.5*t3_d*(0.1130809944*cos(t3) + 0.87550788375*sin(t3) + 0.3334125*m3*sin(t3));...
    0.5*t1_d*(0.0565404972*cos(2.0*t2 + t3) + 0.437753941875*sin(2.0*t2 + t3) + 0.0565404972*cos(t3) + 0.437753941875*sin(t3) + 0.104367106008*cos(2.0*t2 + 2.0*t3) + 0.39144121008291*sin(2.0*t2 + 2.0*t3) + 0.16670625*m3*sin(2.0*t2 + t3) + 0.16670625*m3*sin(t3) + 0.1538600625*m3*sin(2.0*t2 + 2.0*t3)),                                                                                                                                                                                                                                                            0.059245666524375*cos(t2 + t3) - 0.0079916109804*sin(t2 + t3) - 0.5*t1_d*(0.11849133304875*cos(t2 + t3) - 0.0159832219608*sin(t2 + t3)) + 0.5*t2_d*(0.1130809944*cos(t3) + 0.87550788375*sin(t3) + 0.3334125*m3*sin(t3)),                                                                                                                                                                                                                                                                                                               0.059245666524375*cos(t2 + t3) - 0.0079916109804*sin(t2 + t3) - 0.5*t1_d*(0.11849133304875*cos(t2 + t3) - 0.0159832219608*sin(t2 + t3))];

Gest = [0.08916*m1 + 0.08916*m2 + 0.08916*m3 - 0.133036464*cos(t2 + t3) - 1.030009275*sin(t2 + t3) - 1.1160075*sin(t2) - 0.39225*m3*sin(t2 + t3) - 0.425*m2*sin(t2) - 0.425*m3*sin(t2) + 0.234125244;...
 0.08916*m1 + 0.08916*m2 + 0.08916*m3 - 0.133036464*cos(t2 + t3) - 1.030009275*sin(t2 + t3) - 1.1160075*sin(t2) - 0.39225*m3*sin(t2 + t3) - 0.425*m2*sin(t2) - 0.425*m3*sin(t2) + 0.234125244;...
 0.08916*m1 + 0.08916*m2 + 0.08916*m3 - 0.133036464*cos(t2 + t3) - 1.030009275*sin(t2 + t3) - 1.1160075*sin(t2) - 0.39225*m3*sin(t2 + t3) - 0.425*m2*sin(t2) - 0.425*m3*sin(t2) + 0.234125244];
 
 
%% Dynamics
Mmat =  [ 0.826179504375*cos(2.0*t2 + t3) - 0.0565404972*sin(2.0*t2 + t3) + 1.20557253125*cos(2.0*t2) + 0.826179504375*cos(t3) - 0.0565404972*sin(t3) + 0.374967577853955*cos(2.0*t2 + 2.0*t3) - 0.052183553004*sin(2.0*t2 + 2.0*t3) + 1.6342636438878783338097115294829, 0.0159832219608*cos(t2 + t3) + 0.11849133304875*sin(t2 + t3) + 0.128384490875*sin(t2),     0.0159832219608*cos(t2 + t3) + 0.11849133304875*sin(t2 + t3);...
    0.0159832219608*cos(t2 + t3) + 0.11849133304875*sin(t2 + t3) + 0.128384490875*sin(t2),      1.65235900875*cos(t3) - 0.1130809944*sin(t3) + 3.3923104937062566233747997694081, 0.826179504375*cos(t3) - 0.0565404972*sin(t3) + 0.77509501177959;...
    0.0159832219608*cos(t2 + t3) + 0.11849133304875*sin(t2 + t3),                      0.826179504375*cos(t3) - 0.0565404972*sin(t3) + 0.77509501177959,                                0.8215813252545899989958624269093];
Cmat = [ - 0.5*t2_d*(0.1130809944*cos(2.0*t2 + t3) + 1.65235900875*sin(2.0*t2 + t3) + 2.4111450625*sin(2.0*t2) + 0.104367106008*cos(2.0*t2 + 2.0*t3) + 0.74993515570791*sin(2.0*t2 + 2.0*t3)) - 0.5*t3_d*(0.0565404972*cos(2.0*t2 + t3) + 0.826179504375*sin(2.0*t2 + t3) + 0.0565404972*cos(t3) + 0.826179504375*sin(t3) + 0.104367106008*cos(2.0*t2 + 2.0*t3) + 0.74993515570791*sin(2.0*t2 + 2.0*t3)), 0.5*t3_d*(0.2369826660975*cos(t2 + t3) - 0.0319664439216*sin(t2 + t3)) - 0.826179504375*sin(2.0*t2 + t3) - 1.20557253125*sin(2.0*t2) - 0.052183553004*cos(2.0*t2 + 2.0*t3) - 0.374967577853955*sin(2.0*t2 + 2.0*t3) - 0.0565404972*cos(2.0*t2 + t3) + 0.5*t2_d*(0.2369826660975*cos(t2 + t3) - 0.0319664439216*sin(t2 + t3) + 0.25676898175*cos(t2)), 0.5*t2_d*(0.2369826660975*cos(t2 + t3) - 0.0319664439216*sin(t2 + t3)) - 0.4130897521875*sin(2.0*t2 + t3) - 0.0282702486*cos(t3) - 0.4130897521875*sin(t3) - 0.052183553004*cos(2.0*t2 + 2.0*t3) - 0.374967577853955*sin(2.0*t2 + 2.0*t3) - 0.0282702486*cos(2.0*t2 + t3) + 0.5*t3_d*(0.2369826660975*cos(t2 + t3) - 0.0319664439216*sin(t2 + t3));...
    0.5*t1_d*(0.1130809944*cos(2.0*t2 + t3) + 1.65235900875*sin(2.0*t2 + t3) + 2.4111450625*sin(2.0*t2) + 0.104367106008*cos(2.0*t2 + 2.0*t3) + 0.74993515570791*sin(2.0*t2 + 2.0*t3)),                                                                                                 0.059245666524375*cos(t2 + t3) - 0.0079916109804*sin(t2 + t3) + 0.0641922454375*cos(t2) - 0.5*t1_d*(0.11849133304875*cos(t2 + t3) - 0.0159832219608*sin(t2 + t3) + 0.128384490875*cos(t2)) - 0.5*t3_d*(0.1130809944*cos(t3) + 1.65235900875*sin(t3)),                                                                                        0.059245666524375*cos(t2 + t3) - 0.0079916109804*sin(t2 + t3) - 0.5*t1_d*(0.11849133304875*cos(t2 + t3) - 0.0159832219608*sin(t2 + t3)) - 0.5*t2_d*(0.1130809944*cos(t3) + 1.65235900875*sin(t3)) - 0.5*t3_d*(0.1130809944*cos(t3) + 1.65235900875*sin(t3));...
    0.5*t1_d*(0.0565404972*cos(2.0*t2 + t3) + 0.826179504375*sin(2.0*t2 + t3) + 0.0565404972*cos(t3) + 0.826179504375*sin(t3) + 0.104367106008*cos(2.0*t2 + 2.0*t3) + 0.74993515570791*sin(2.0*t2 + 2.0*t3)),                                                                                                                                                    0.059245666524375*cos(t2 + t3) - 0.0079916109804*sin(t2 + t3) - 0.5*t1_d*(0.11849133304875*cos(t2 + t3) - 0.0159832219608*sin(t2 + t3)) + 0.5*t2_d*(0.1130809944*cos(t3) + 1.65235900875*sin(t3)),                                                                                                                                                                                                            0.059245666524375*cos(t2 + t3) - 0.0079916109804*sin(t2 + t3) - 0.5*t1_d*(0.11849133304875*cos(t2 + t3) - 0.0159832219608*sin(t2 + t3))];
Gmat = [ 1.520079924 - 1.943951775*sin(t2 + t3) - 5.6732825*sin(t2) - 0.133036464*cos(t2 + t3);...
 1.520079924 - 1.943951775*sin(t2 + t3) - 5.6732825*sin(t2) - 0.133036464*cos(t2 + t3);...
 1.520079924 - 1.943951775*sin(t2 + t3) - 5.6732825*sin(t2) - 0.133036464*cos(t2 + t3)];
invM = inv(Mmat);
%% Jacobian
J = [ 0.19145000000000000579013006636869*cos(t1) + 0.39225*cos(t3)*(0.00000000000000006123233995736766035868820147292*cos(t1)*sin(t2) + cos(t2)*sin(t1)) + 0.000000000000000026023744481881255652442485625991*cos(t1)*sin(t2) + 0.425*cos(t2)*sin(t1) - 0.09456*sin(t3)*(0.00000000000000006123233995736766035868820147292*cos(t1)*sin(t2) + cos(t2)*sin(t1)) + 0.09456*cos(t3)*(0.00000000000000006123233995736766035868820147292*cos(t1)*cos(t2) - 1.0*sin(t1)*sin(t2)) + 0.39225*sin(t3)*(0.00000000000000006123233995736766035868820147292*cos(t1)*cos(t2) - 1.0*sin(t1)*sin(t2)),         0.09456*cos(t3)*(cos(t1)*cos(t2) - 0.00000000000000006123233995736766035868820147292*sin(t1)*sin(t2)) + 0.39225*cos(t3)*(cos(t1)*sin(t2) + 0.00000000000000006123233995736766035868820147292*cos(t2)*sin(t1)) + 0.425*cos(t1)*sin(t2) + 0.000000000000000026023744481881255652442485625991*cos(t2)*sin(t1) + 0.39225*sin(t3)*(cos(t1)*cos(t2) - 0.00000000000000006123233995736766035868820147292*sin(t1)*sin(t2)) - 0.09456*sin(t3)*(cos(t1)*sin(t2) + 0.00000000000000006123233995736766035868820147292*cos(t2)*sin(t1)),         0.09456*cos(t3)*(cos(t1)*cos(t2) - 0.00000000000000006123233995736766035868820147292*sin(t1)*sin(t2)) + 0.39225*cos(t3)*(cos(t1)*sin(t2) + 0.00000000000000006123233995736766035868820147292*cos(t2)*sin(t1)) + 0.39225*sin(t3)*(cos(t1)*cos(t2) - 0.00000000000000006123233995736766035868820147292*sin(t1)*sin(t2)) - 0.09456*sin(t3)*(cos(t1)*sin(t2) + 0.00000000000000006123233995736766035868820147292*cos(t2)*sin(t1));...
         0.19145000000000000579013006636869*sin(t1) - 0.425*cos(t1)*cos(t2) - 0.39225*cos(t3)*(cos(t1)*cos(t2) - 0.00000000000000006123233995736766035868820147292*sin(t1)*sin(t2)) + 0.09456*cos(t3)*(cos(t1)*sin(t2) + 0.00000000000000006123233995736766035868820147292*cos(t2)*sin(t1)) + 0.09456*sin(t3)*(cos(t1)*cos(t2) - 0.00000000000000006123233995736766035868820147292*sin(t1)*sin(t2)) + 0.39225*sin(t3)*(cos(t1)*sin(t2) + 0.00000000000000006123233995736766035868820147292*cos(t2)*sin(t1)) + 0.000000000000000026023744481881255652442485625991*sin(t1)*sin(t2), 0.09456*cos(t3)*(0.00000000000000006123233995736766035868820147292*cos(t1)*sin(t2) + cos(t2)*sin(t1)) - 0.000000000000000026023744481881255652442485625991*cos(t1)*cos(t2) + 0.39225*sin(t3)*(0.00000000000000006123233995736766035868820147292*cos(t1)*sin(t2) + cos(t2)*sin(t1)) + 0.425*sin(t1)*sin(t2) - 0.39225*cos(t3)*(0.00000000000000006123233995736766035868820147292*cos(t1)*cos(t2) - 1.0*sin(t1)*sin(t2)) + 0.09456*sin(t3)*(0.00000000000000006123233995736766035868820147292*cos(t1)*cos(t2) - 1.0*sin(t1)*sin(t2)), 0.09456*cos(t3)*(0.00000000000000006123233995736766035868820147292*cos(t1)*sin(t2) + cos(t2)*sin(t1)) + 0.39225*sin(t3)*(0.00000000000000006123233995736766035868820147292*cos(t1)*sin(t2) + cos(t2)*sin(t1)) - 0.39225*cos(t3)*(0.00000000000000006123233995736766035868820147292*cos(t1)*cos(t2) - 1.0*sin(t1)*sin(t2)) + 0.09456*sin(t3)*(0.00000000000000006123233995736766035868820147292*cos(t1)*cos(t2) - 1.0*sin(t1)*sin(t2));...
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               0,                                                                                                                                                                                                                                                                                                                                                                                                              0.09456*cos(t2)*sin(t3) - 0.39225*cos(t2)*cos(t3) - 0.425*cos(t2) + 0.09456*cos(t3)*sin(t2) + 0.39225*sin(t2)*sin(t3),                                                                                                                                                                                                                                                                                                                                 0.09456*cos(t2)*sin(t3) - 0.39225*cos(t2)*cos(t3) + 0.09456*cos(t3)*sin(t2) + 0.39225*sin(t2)*sin(t3)];
Jdot = [ 0.39225*cos(t3)*(t1_d*cos(t1)*cos(t2) + 0.00000000000000006123233995736766035868820147292*t2_d*cos(t1)*cos(t2) - 0.00000000000000006123233995736766035868820147292*t1_d*sin(t1)*sin(t2) - 1.0*t2_d*sin(t1)*sin(t2)) - 0.19145000000000000579013006636869*t1_d*sin(t1) - 0.09456*sin(t3)*(t1_d*cos(t1)*cos(t2) + 0.00000000000000006123233995736766035868820147292*t2_d*cos(t1)*cos(t2) - 0.00000000000000006123233995736766035868820147292*t1_d*sin(t1)*sin(t2) - 1.0*t2_d*sin(t1)*sin(t2)) - 0.09456*cos(t3)*(1.0*t1_d*cos(t1)*sin(t2) + 0.00000000000000006123233995736766035868820147292*t1_d*cos(t2)*sin(t1) + 0.00000000000000006123233995736766035868820147292*t2_d*cos(t1)*sin(t2) + 1.0*t2_d*cos(t2)*sin(t1)) - 0.39225*sin(t3)*(1.0*t1_d*cos(t1)*sin(t2) + 0.00000000000000006123233995736766035868820147292*t1_d*cos(t2)*sin(t1) + 0.00000000000000006123233995736766035868820147292*t2_d*cos(t1)*sin(t2) + 1.0*t2_d*cos(t2)*sin(t1)) + 0.425*t1_d*cos(t1)*cos(t2) + 0.000000000000000026023744481881255652442485625991*t2_d*cos(t1)*cos(t2) - 0.09456*t3_d*cos(t3)*(0.00000000000000006123233995736766035868820147292*cos(t1)*sin(t2) + cos(t2)*sin(t1)) - 0.39225*t3_d*sin(t3)*(0.00000000000000006123233995736766035868820147292*cos(t1)*sin(t2) + cos(t2)*sin(t1)) - 0.000000000000000026023744481881255652442485625991*t1_d*sin(t1)*sin(t2) - 0.425*t2_d*sin(t1)*sin(t2) + 0.39225*t3_d*cos(t3)*(0.00000000000000006123233995736766035868820147292*cos(t1)*cos(t2) - 1.0*sin(t1)*sin(t2)) - 0.09456*t3_d*sin(t3)*(0.00000000000000006123233995736766035868820147292*cos(t1)*cos(t2) - 1.0*sin(t1)*sin(t2)),                         0.39225*cos(t3)*(0.00000000000000006123233995736766035868820147292*t1_d*cos(t1)*cos(t2) + t2_d*cos(t1)*cos(t2) - 1.0*t1_d*sin(t1)*sin(t2) - 0.00000000000000006123233995736766035868820147292*t2_d*sin(t1)*sin(t2)) - 0.39225*sin(t3)*(0.00000000000000006123233995736766035868820147292*t1_d*cos(t1)*sin(t2) + t1_d*cos(t2)*sin(t1) + t2_d*cos(t1)*sin(t2) + 0.00000000000000006123233995736766035868820147292*t2_d*cos(t2)*sin(t1)) - 0.09456*cos(t3)*(0.00000000000000006123233995736766035868820147292*t1_d*cos(t1)*sin(t2) + t1_d*cos(t2)*sin(t1) + t2_d*cos(t1)*sin(t2) + 0.00000000000000006123233995736766035868820147292*t2_d*cos(t2)*sin(t1)) - 0.09456*sin(t3)*(0.00000000000000006123233995736766035868820147292*t1_d*cos(t1)*cos(t2) + t2_d*cos(t1)*cos(t2) - 1.0*t1_d*sin(t1)*sin(t2) - 0.00000000000000006123233995736766035868820147292*t2_d*sin(t1)*sin(t2)) + 0.000000000000000026023744481881255652442485625991*t1_d*cos(t1)*cos(t2) + 0.425*t2_d*cos(t1)*cos(t2) + 0.39225*t3_d*cos(t3)*(cos(t1)*cos(t2) - 0.00000000000000006123233995736766035868820147292*sin(t1)*sin(t2)) - 0.09456*t3_d*cos(t3)*(cos(t1)*sin(t2) + 0.00000000000000006123233995736766035868820147292*cos(t2)*sin(t1)) - 0.09456*t3_d*sin(t3)*(cos(t1)*cos(t2) - 0.00000000000000006123233995736766035868820147292*sin(t1)*sin(t2)) - 0.39225*t3_d*sin(t3)*(cos(t1)*sin(t2) + 0.00000000000000006123233995736766035868820147292*cos(t2)*sin(t1)) - 0.425*t1_d*sin(t1)*sin(t2) - 0.000000000000000026023744481881255652442485625991*t2_d*sin(t1)*sin(t2),                         0.39225*cos(t3)*(0.00000000000000006123233995736766035868820147292*t1_d*cos(t1)*cos(t2) + t2_d*cos(t1)*cos(t2) - 1.0*t1_d*sin(t1)*sin(t2) - 0.00000000000000006123233995736766035868820147292*t2_d*sin(t1)*sin(t2)) - 0.39225*sin(t3)*(0.00000000000000006123233995736766035868820147292*t1_d*cos(t1)*sin(t2) + t1_d*cos(t2)*sin(t1) + t2_d*cos(t1)*sin(t2) + 0.00000000000000006123233995736766035868820147292*t2_d*cos(t2)*sin(t1)) - 0.09456*cos(t3)*(0.00000000000000006123233995736766035868820147292*t1_d*cos(t1)*sin(t2) + t1_d*cos(t2)*sin(t1) + t2_d*cos(t1)*sin(t2) + 0.00000000000000006123233995736766035868820147292*t2_d*cos(t2)*sin(t1)) - 0.09456*sin(t3)*(0.00000000000000006123233995736766035868820147292*t1_d*cos(t1)*cos(t2) + t2_d*cos(t1)*cos(t2) - 1.0*t1_d*sin(t1)*sin(t2) - 0.00000000000000006123233995736766035868820147292*t2_d*sin(t1)*sin(t2)) + 0.39225*t3_d*cos(t3)*(cos(t1)*cos(t2) - 0.00000000000000006123233995736766035868820147292*sin(t1)*sin(t2)) - 0.09456*t3_d*cos(t3)*(cos(t1)*sin(t2) + 0.00000000000000006123233995736766035868820147292*cos(t2)*sin(t1)) - 0.09456*t3_d*sin(t3)*(cos(t1)*cos(t2) - 0.00000000000000006123233995736766035868820147292*sin(t1)*sin(t2)) - 0.39225*t3_d*sin(t3)*(cos(t1)*sin(t2) + 0.00000000000000006123233995736766035868820147292*cos(t2)*sin(t1));...
                         0.39225*cos(t3)*(0.00000000000000006123233995736766035868820147292*t1_d*cos(t1)*sin(t2) + t1_d*cos(t2)*sin(t1) + t2_d*cos(t1)*sin(t2) + 0.00000000000000006123233995736766035868820147292*t2_d*cos(t2)*sin(t1)) - 0.09456*sin(t3)*(0.00000000000000006123233995736766035868820147292*t1_d*cos(t1)*sin(t2) + t1_d*cos(t2)*sin(t1) + t2_d*cos(t1)*sin(t2) + 0.00000000000000006123233995736766035868820147292*t2_d*cos(t2)*sin(t1)) + 0.19145000000000000579013006636869*t1_d*cos(t1) + 0.09456*cos(t3)*(0.00000000000000006123233995736766035868820147292*t1_d*cos(t1)*cos(t2) + t2_d*cos(t1)*cos(t2) - 1.0*t1_d*sin(t1)*sin(t2) - 0.00000000000000006123233995736766035868820147292*t2_d*sin(t1)*sin(t2)) + 0.39225*sin(t3)*(0.00000000000000006123233995736766035868820147292*t1_d*cos(t1)*cos(t2) + t2_d*cos(t1)*cos(t2) - 1.0*t1_d*sin(t1)*sin(t2) - 0.00000000000000006123233995736766035868820147292*t2_d*sin(t1)*sin(t2)) + 0.09456*t3_d*cos(t3)*(cos(t1)*cos(t2) - 0.00000000000000006123233995736766035868820147292*sin(t1)*sin(t2)) + 0.39225*t3_d*cos(t3)*(cos(t1)*sin(t2) + 0.00000000000000006123233995736766035868820147292*cos(t2)*sin(t1)) + 0.000000000000000026023744481881255652442485625991*t1_d*cos(t1)*sin(t2) + 0.425*t1_d*cos(t2)*sin(t1) + 0.425*t2_d*cos(t1)*sin(t2) + 0.000000000000000026023744481881255652442485625991*t2_d*cos(t2)*sin(t1) + 0.39225*t3_d*sin(t3)*(cos(t1)*cos(t2) - 0.00000000000000006123233995736766035868820147292*sin(t1)*sin(t2)) - 0.09456*t3_d*sin(t3)*(cos(t1)*sin(t2) + 0.00000000000000006123233995736766035868820147292*cos(t2)*sin(t1)), 0.09456*cos(t3)*(t1_d*cos(t1)*cos(t2) + 0.00000000000000006123233995736766035868820147292*t2_d*cos(t1)*cos(t2) - 0.00000000000000006123233995736766035868820147292*t1_d*sin(t1)*sin(t2) - 1.0*t2_d*sin(t1)*sin(t2)) + 0.39225*sin(t3)*(t1_d*cos(t1)*cos(t2) + 0.00000000000000006123233995736766035868820147292*t2_d*cos(t1)*cos(t2) - 0.00000000000000006123233995736766035868820147292*t1_d*sin(t1)*sin(t2) - 1.0*t2_d*sin(t1)*sin(t2)) + 0.39225*cos(t3)*(1.0*t1_d*cos(t1)*sin(t2) + 0.00000000000000006123233995736766035868820147292*t1_d*cos(t2)*sin(t1) + 0.00000000000000006123233995736766035868820147292*t2_d*cos(t1)*sin(t2) + 1.0*t2_d*cos(t2)*sin(t1)) - 0.09456*sin(t3)*(1.0*t1_d*cos(t1)*sin(t2) + 0.00000000000000006123233995736766035868820147292*t1_d*cos(t2)*sin(t1) + 0.00000000000000006123233995736766035868820147292*t2_d*cos(t1)*sin(t2) + 1.0*t2_d*cos(t2)*sin(t1)) + 0.39225*t3_d*cos(t3)*(0.00000000000000006123233995736766035868820147292*cos(t1)*sin(t2) + cos(t2)*sin(t1)) + 0.425*t1_d*cos(t1)*sin(t2) + 0.000000000000000026023744481881255652442485625991*t1_d*cos(t2)*sin(t1) + 0.000000000000000026023744481881255652442485625991*t2_d*cos(t1)*sin(t2) + 0.425*t2_d*cos(t2)*sin(t1) - 0.09456*t3_d*sin(t3)*(0.00000000000000006123233995736766035868820147292*cos(t1)*sin(t2) + cos(t2)*sin(t1)) + 0.09456*t3_d*cos(t3)*(0.00000000000000006123233995736766035868820147292*cos(t1)*cos(t2) - 1.0*sin(t1)*sin(t2)) + 0.39225*t3_d*sin(t3)*(0.00000000000000006123233995736766035868820147292*cos(t1)*cos(t2) - 1.0*sin(t1)*sin(t2)), 0.09456*cos(t3)*(t1_d*cos(t1)*cos(t2) + 0.00000000000000006123233995736766035868820147292*t2_d*cos(t1)*cos(t2) - 0.00000000000000006123233995736766035868820147292*t1_d*sin(t1)*sin(t2) - 1.0*t2_d*sin(t1)*sin(t2)) + 0.39225*sin(t3)*(t1_d*cos(t1)*cos(t2) + 0.00000000000000006123233995736766035868820147292*t2_d*cos(t1)*cos(t2) - 0.00000000000000006123233995736766035868820147292*t1_d*sin(t1)*sin(t2) - 1.0*t2_d*sin(t1)*sin(t2)) + 0.39225*cos(t3)*(1.0*t1_d*cos(t1)*sin(t2) + 0.00000000000000006123233995736766035868820147292*t1_d*cos(t2)*sin(t1) + 0.00000000000000006123233995736766035868820147292*t2_d*cos(t1)*sin(t2) + 1.0*t2_d*cos(t2)*sin(t1)) - 0.09456*sin(t3)*(1.0*t1_d*cos(t1)*sin(t2) + 0.00000000000000006123233995736766035868820147292*t1_d*cos(t2)*sin(t1) + 0.00000000000000006123233995736766035868820147292*t2_d*cos(t1)*sin(t2) + 1.0*t2_d*cos(t2)*sin(t1)) + 0.39225*t3_d*cos(t3)*(0.00000000000000006123233995736766035868820147292*cos(t1)*sin(t2) + cos(t2)*sin(t1)) - 0.09456*t3_d*sin(t3)*(0.00000000000000006123233995736766035868820147292*cos(t1)*sin(t2) + cos(t2)*sin(t1)) + 0.09456*t3_d*cos(t3)*(0.00000000000000006123233995736766035868820147292*cos(t1)*cos(t2) - 1.0*sin(t1)*sin(t2)) + 0.39225*t3_d*sin(t3)*(0.00000000000000006123233995736766035868820147292*cos(t1)*cos(t2) - 1.0*sin(t1)*sin(t2));...
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         0,                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              0.425*t2_d*sin(t2) + 0.09456*t2_d*cos(t2)*cos(t3) + 0.09456*t3_d*cos(t2)*cos(t3) + 0.39225*t2_d*cos(t2)*sin(t3) + 0.39225*t2_d*cos(t3)*sin(t2) + 0.39225*t3_d*cos(t2)*sin(t3) + 0.39225*t3_d*cos(t3)*sin(t2) - 0.09456*t2_d*sin(t2)*sin(t3) - 0.09456*t3_d*sin(t2)*sin(t3),                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     0.09456*t2_d*cos(t2)*cos(t3) + 0.09456*t3_d*cos(t2)*cos(t3) + 0.39225*t2_d*cos(t2)*sin(t3) + 0.39225*t2_d*cos(t3)*sin(t2) + 0.39225*t3_d*cos(t2)*sin(t3) + 0.39225*t3_d*cos(t3)*sin(t2) - 0.09456*t2_d*sin(t2)*sin(t3) - 0.09456*t3_d*sin(t2)*sin(t3)];

T = fk_ur5(t1,t2,t3);
x = [T(1,4);T(2,4);T(3,4)];
xdot = J*dtheta;

x_d =  [-0.6905*(t/1000)-0.6682*(1-t/1000);-0.3348*(t/1000)-0.3952*(1-t/1000);-0.2351];
dx_d =  1.0e-04 *[-0.2230;0.6040;0];
ddx_d = [0;0;0];
%Calculating the noise
P = 0.005*eye(6);
B = [0;0;0;1;1;1];
rho=1;
e=[x-x_d;xdot-dx_d];

if (transpose(e)*P*B ~=0)
    v = -transpose(e)*P*B*rho/norm(transpose(e)*P*B);
else
    v =0;
end
    
x-x_d
ddx = ddx_d - Kp*(x-x_d)-Kd*(xdot-dx_d);
aq = inv(J)*ddx - Jdot*dtheta+v;
eta = inv(Mmat)*((Mmat-Mest)*aq + (Cmat-Cest)*dtheta + (Gmat-Gest));
Torque = Mest*(aq)+ Cest*dtheta +Gest;
dq = [dtheta; invM*(Torque- Gmat)-invM*Cmat*dtheta+eta];
    

end

% The forward kinematics function
function [T] = fk_ur5(q1,q2,q3)
%% Transformation Matrices Using DH Parameters (a, alpha, theta, d)

T10 = DH_matrix(0, pi/2, q1, 0.08916);
T21 = DH_matrix(-0.425, 0, q2, 0);
T32 = DH_matrix(-0.39225, 0, q3, 0);
T43 = DH_matrix(0, pi/2, 0, 0.10915);
T54 = DH_matrix(0, -pi/2, 0, 0.09456);
T65 = DH_matrix(0, 0, 0, 0.0823);

%% Transformation Matrices wrt Base frames
T20 = T10 * T21;
T30 = T20 * T32;
T40 = T30 * T43;
T50 = T40 * T54;
T = T50 * T65;

end
